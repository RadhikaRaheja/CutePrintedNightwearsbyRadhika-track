<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track Your Order</title>
  <link rel="icon" href="https://github.com/Himanshu-Mittal001/Gurukul-Images/blob/main/CPN%20logo.jpg?raw=true">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #fafafa;
      font-family: 'Segoe UI', sans-serif;
    }
    .logo {
      width: 80px;
      height: 80px;
      border-radius: 20px;
    }
    .search-section select, .search-section input {
      margin-bottom: 10px;
    }
    .container-box {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    .blur-bg {
      filter: blur(5px);
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      display: none;
    }
    .pagination .page-link {
      margin: 2px;
    }
    .emoji-label {
      margin-right: 5px;
    }
    .footer {
      text-align: center;
      margin-top: 40px;
      color: gray;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="text-center mb-3">
      <img class="logo" src="https://github.com/Himanshu-Mittal001/Gurukul-Images/blob/main/CPN%20logo.jpg?raw=true" alt="Logo">
      <h3 class="mt-2">Track Your Order</h3>
    </div>
    <div class="container-box mx-auto" style="max-width: 1000px;">
      <div class="row search-section">
        <div class="col-md-4">
          <label class="emoji-label">üîç</label>
          <select class="form-select" id="searchCategory">
            <option value="Name">üßë Name</option>
            <option value="Pincode">üìç Pincode</option>
            <option value="Date">üìÖ Date</option>
            <option value="Tracking ID">üî¢ Tracking Code</option>
          </select>
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" id="searchInput" placeholder="Enter search value...">
        </div>
        <div class="col-md-2">
          <button class="btn btn-dark w-100" onclick="performSearch()">Search</button>
        </div>
      </div>
      <div class="mt-4">
        <table class="table table-bordered table-hover text-center" id="dataTable">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Customer Name</th>
              <th>Location</th>
              <th>Courier Name</th>
              <th>Tracking ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="d-flex justify-content-center">
          <nav>
            <ul class="pagination" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
    <div class="footer">¬© Cute Printed Nightwears by Radhika ‚ù§Ô∏è</div>
  </div>

  <div id="popup" class="popup"></div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgmnkzToixRC4mmO3WMSjZTjVvWUPgHCQYzpySJeiItTswTJTK9Vg1-iHyvPfptQ/pub?output=csv";
    const courierURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgmnkzToixRC4mmO3WMSjZTjVvWUPgHCQYzpySJeiItTswTJTK9Vg1-iHyvPfptQ/pub?gid=1710283637&single=true&output=csv";

    let rawData = [];
    let courierMap = {};
    let currentPage = 1;
    const rowsPerPage = 10;

    function fetchData() {
      Promise.all([fetch(sheetURL), fetch(courierURL)])
        .then(responses => Promise.all(responses.map(res => res.text())))
        .then(([salesCSV, courierCSV]) => {
          rawData = CSVToArray(salesCSV).slice(1);
          const courierRows = CSVToArray(courierCSV).slice(1);
          courierRows.forEach(row => {
            if (row[0]) courierMap[row[0].trim()] = row[2];
          });
          renderTable();
        });
    }

    function CSVToArray(strData, strDelimiter) {
      strDelimiter = strDelimiter || ",";
      const pattern = new RegExp(("(") + strDelimiter + "|\r?\n|\r|^)(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^" + strDelimiter + "\r\n]*))", "gi");
      let arrData = [[]];
      let matches = null;
      while ((matches = pattern.exec(strData))) {
        const matchedDelimiter = matches[1];
        if (matchedDelimiter.length && matchedDelimiter !== strDelimiter) arrData.push([]);
        const matchedValue = matches[2] ? matches[2].replace(/""/g, '"') : matches[3];
        arrData[arrData.length - 1].push(matchedValue);
      }
      return arrData;
    }

    function renderTable() {
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const displayRows = rawData.slice(start, end);
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = '';

      displayRows.forEach(row => {
        const courierName = row[8];
        const trackingId = row[9];
        const courierLink = courierMap[courierName] || "#";
        const html = `
          <tr onclick="showPopup('${row[0]}', '${row[1]}', '${row[3]}', '${courierName}', '${trackingId}')">
            <td>${row[0]}</td>
            <td>${row[1]}</td>
            <td>${row[3]}</td>
            <td><a href="${courierLink}" target="_blank">${courierName}</a></td>
            <td>${trackingId}</td>
          </tr>
        `;
        tbody.innerHTML += html;
      });

      renderPagination();
    }

    function renderPagination() {
      const pageCount = Math.ceil(rawData.length / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(pageCount, startPage + 4);
      if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

      for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="gotoPage(${i})">${i}</a></li>`;
      }
    }

    function gotoPage(num) {
      currentPage = num;
      renderTable();
    }

    function performSearch() {
      const cat = document.getElementById("searchCategory").value;
      const query = document.getElementById("searchInput").value.toLowerCase();
      let index;
      if (cat === "Name") index = 1;
      if (cat === "Pincode") index = 3;
      if (cat === "Date") index = 0;
      if (cat === "Tracking ID") index = 9;

      rawData = rawData.filter(row => row[index] && row[index].toLowerCase().includes(query));
      currentPage = 1;
      renderTable();
    }

    function showPopup(date, name, location, courier, trackingId) {
      const popup = document.getElementById("popup");
      popup.innerHTML = `
        <h5>üìÖ ${date}</h5>
        <p>üßë <strong>${name}</strong></p>
        <p>üìç ${location}</p>
        <p>üì¶ ${courier}</p>
        <p>üî¢ ${trackingId}</p>
        <button class="btn btn-danger mt-3" onclick="closePopup()">Close</button>
      `;
      popup.style.display = "block";
      document.querySelector(".container").classList.add("blur-bg");
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
      document.querySelector(".container").classList.remove("blur-bg");
    }

    fetchData();
  </script>
</body>

</html>
